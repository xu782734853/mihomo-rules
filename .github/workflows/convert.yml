name: è½¬æ¢ MRS è§„åˆ™

on:
  push:
    branches:
      - main
    paths:
      - 'rules/text/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½ Mihomo
        run: |
          # è·å–æœ€æ–°ç‰ˆæœ¬
          LATEST_VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_VERSION"
          
          # ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
          wget "https://github.com/MetaCubeX/mihomo/releases/download/${LATEST_VERSION}/mihomo-linux-amd64-${LATEST_VERSION}.gz"
          
          # è§£å‹
          gunzip "mihomo-linux-amd64-${LATEST_VERSION}.gz"
          mv "mihomo-linux-amd64-${LATEST_VERSION}" mihomo
          chmod +x mihomo
          
          # éªŒè¯
          ./mihomo version
      
      - name: åˆ›å»ºè¾“å‡ºç›®å½•
        run: |
          mkdir -p rules/mrs
      
      - name: è½¬æ¢è§„åˆ™æ–‡ä»¶
        run: |
          # éå†æ‰€æœ‰æ–‡æœ¬è§„åˆ™æ–‡ä»¶å¹¶è½¬æ¢
          for txt_file in rules/text/*.txt; do
            if [ -f "$txt_file" ]; then
              filename=$(basename "$txt_file" .txt)
              
              echo "æ­£åœ¨è½¬æ¢: $filename"
              
              # æ ¹æ®æ–‡ä»¶ååˆ¤æ–­è§„åˆ™ç±»å‹
              case "$filename" in
                domain|domain_suffix|domain_keyword)
                  behavior="domain"
                  ;;
                ipcidr|ip_cidr|ipcidr6)
                  behavior="ipcidr"
                  ;;
                classical|mixed)
                  behavior="classical"
                  ;;
                *)
                  # é»˜è®¤ä½¿ç”¨ domain
                  behavior="domain"
                  ;;
              esac
              
              # æ‰§è¡Œè½¬æ¢
              ./mihomo convert-ruleset "$behavior" text "$txt_file" "rules/mrs/${filename}.mrs"
              
              if [ $? -eq 0 ]; then
                echo "âœ… ${filename}.mrs è½¬æ¢æˆåŠŸ"
                ls -lh "rules/mrs/${filename}.mrs"
              else
                echo "âŒ ${filename}.mrs è½¬æ¢å¤±è´¥"
              fi
            fi
          done
      
      - name: ç”Ÿæˆè§„åˆ™åˆ—è¡¨
        run: |
          echo "# å¯ç”¨è§„åˆ™" > rules/mrs/README.md
          echo "" >> rules/mrs/README.md
          echo "ç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> rules/mrs/README.md
          echo "" >> rules/mrs/README.md
          echo "| æ–‡ä»¶å | å¤§å° | ä¸‹è½½é“¾æ¥ |" >> rules/mrs/README.md
          echo "|--------|------|----------|" >> rules/mrs/README.md
          
          for mrs_file in rules/mrs/*.mrs; do
            if [ -f "$mrs_file" ]; then
              filename=$(basename "$mrs_file")
              filesize=$(ls -lh "$mrs_file" | awk '{print $5}')
              echo "| $filename | $filesize | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/latest/download/$filename) |" >> rules/mrs/README.md
            fi
          done
      
      - name: æäº¤è½¬æ¢ç»“æœ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/mrs/
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨è½¬æ¢ MRS è§„åˆ™ [$(date '+%Y-%m-%d %H:%M:%S')]"
          git push
      
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: MRS Rules v${{ github.run_number }}
          body: |
            ğŸ‰ è‡ªåŠ¨ç”Ÿæˆçš„ MRS è§„åˆ™é›†
            
            **ç”Ÿæˆæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}
            
            ## ğŸ“¥ ä½¿ç”¨æ–¹æ³•
            
            åœ¨ mihomo é…ç½®ä¸­æ·»åŠ ï¼š
            
            ```yaml
            rule-providers:
              my-rules:
                type: http
                behavior: domain  # æ ¹æ®å®é™…ç±»å‹ä¿®æ”¹
                format: mrs
                url: "https://github.com/${{ github.repository }}/releases/latest/download/domain.mrs"
                interval: 86400
            ```
            
            ## ğŸ“‹ å¯ç”¨æ–‡ä»¶
            
            æŸ¥çœ‹ä¸‹æ–¹ Assets ä¸­çš„æ‰€æœ‰ .mrs æ–‡ä»¶
          files: |
            rules/mrs/*.mrs
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
