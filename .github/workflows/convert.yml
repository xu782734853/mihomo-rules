name: è½¬æ¢ MRSï¼ˆæ™ºèƒ½ç‰ˆï¼‰

on:
  push:
    branches:
      - main
    paths:
      - 'rules/text/**'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½ Mihomo
        run: |
          VERSION="v1.18.10"
          FILE="mihomo-linux-amd64-${VERSION}.gz"
          
          MIRRORS=(
            "https://mirror.ghproxy.com/https://github.com/MetaCubeX/mihomo/releases/download/${VERSION}/${FILE}"
            "https://gh.api.99988866.xyz/https://github.com/MetaCubeX/mihomo/releases/download/${VERSION}/${FILE}"
          )
          
          for mirror in "${MIRRORS[@]}"; do
            echo "ğŸ“¥ å°è¯•: $mirror"
            if wget -q --timeout=30 "$mirror" -O mihomo.gz; then
              gunzip mihomo.gz
              chmod +x mihomo
              echo "âœ… ä¸‹è½½æˆåŠŸ"
              break
            fi
          done
      
      - name: è½¬æ¢è§„åˆ™
        run: |
          mkdir -p rules/mrs
          
          for txt_file in rules/text/*.txt; do
            [ -f "$txt_file" ] || continue
            
            filename=$(basename "$txt_file" .txt)
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©ºæˆ–åªæœ‰æ³¨é‡Š
            if ! grep -qvE '^\s*(#.*)?$' "$txt_file"; then
              echo "âš ï¸  è·³è¿‡ç©ºæ–‡ä»¶: $filename"
              continue
            fi
            
            # è®¡ç®—æœ‰æ•ˆè¡Œæ•°
            valid_lines=$(grep -cvE '^\s*(#.*)?$' "$txt_file" || echo 0)
            if [ "$valid_lines" -eq 0 ]; then
              echo "âš ï¸  è·³è¿‡ $filename (æ— æœ‰æ•ˆè§„åˆ™)"
              continue
            fi
            
            echo "ğŸ”„ è½¬æ¢ $filename ($valid_lines æ¡è§„åˆ™)"
            
            # åˆ¤æ–­ç±»å‹
            if [[ "$filename" =~ domain ]]; then
              behavior="domain"
            elif [[ "$filename" =~ ip ]]; then
              behavior="ipcidr"
            else
              behavior="domain"
            fi
            
            # æ‰§è¡Œè½¬æ¢ï¼Œæ•è·é”™è¯¯
            if ./mihomo convert-ruleset "$behavior" text "$txt_file" "rules/mrs/${filename}.mrs" 2>&1 | tee /tmp/convert.log; then
              if [ -f "rules/mrs/${filename}.mrs" ]; then
                size=$(ls -lh "rules/mrs/${filename}.mrs" | awk '{print $5}')
                echo "âœ… ${filename}.mrs ($size)"
              else
                echo "âŒ ${filename}.mrs æ–‡ä»¶æœªç”Ÿæˆ"
                cat /tmp/convert.log
              fi
            else
              echo "âŒ ${filename}.mrs è½¬æ¢å¤±è´¥"
              cat /tmp/convert.log
            fi
          done
          
          echo ""
          echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶ï¼š"
          ls -lh rules/mrs/ 2>/dev/null || echo "æ— æ–‡ä»¶ç”Ÿæˆ"
      
      - name: æ£€æŸ¥ç»“æœ
        run: |
          if [ ! -d "rules/mrs" ] || [ -z "$(ls -A rules/mrs/*.mrs 2>/dev/null)" ]; then
            echo "âš ï¸  è­¦å‘Šï¼šæ²¡æœ‰ç”Ÿæˆä»»ä½• MRS æ–‡ä»¶"
            echo "è¯·æ£€æŸ¥ rules/text/ ç›®å½•ä¸­çš„æ–‡ä»¶å†…å®¹"
            exit 1
          fi
      
      - name: ç”Ÿæˆè¯´æ˜
        run: |
          cat > rules/mrs/README.md << 'EOF'
# MRS è§„åˆ™é›†

ç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')

## å¯ç”¨æ–‡ä»¶

| æ–‡ä»¶å | å¤§å° | è§„åˆ™æ•° | ä¸‹è½½é“¾æ¥ |
|--------|------|--------|----------|
EOF
          
          for mrs_file in rules/mrs/*.mrs; do
            if [ -f "$mrs_file" ]; then
              filename=$(basename "$mrs_file")
              filesize=$(ls -lh "$mrs_file" | awk '{print $5}')
              echo "| $filename | $filesize | - | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/latest/download/$filename) |" >> rules/mrs/README.md
            fi
          done
      
      - name: æäº¤ç»“æœ
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rules/mrs/
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– æ›´æ–° MRS [$(date '+%Y-%m-%d')]"
          git push
      
      - name: å‘å¸ƒ Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Rules v${{ github.run_number }}
          body: |
            ğŸ“¦ MRS è§„åˆ™é›† - è‡ªåŠ¨ç”Ÿæˆ
            
            ## ä½¿ç”¨æ–¹æ³•
            
            **Domain è§„åˆ™ï¼š**
            ```yaml
            rule-providers:
              my-domain:
                type: http
                behavior: domain
                format: mrs
                url: "https://github.com/${{ github.repository }}/releases/latest/download/domain.mrs"
                interval: 86400
            
            rules:
              - RULE-SET,my-domain,PROXY
            ```
            
            **IP è§„åˆ™ï¼š**
            ```yaml
            rule-providers:
              my-ipcidr:
                type: http
                behavior: ipcidr
                format: mrs
                url: "https://github.com/${{ github.repository }}/releases/latest/download/ipcidr.mrs"
                interval: 86400
            
            rules:
              - RULE-SET,my-ipcidr,DIRECT
            ```
          files: rules/mrs/*.mrs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
