name: è½¬æ¢ MRS è§„åˆ™

on:
  push:
    branches:
      - main
    paths:
      - 'rules/text/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  convert:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½ Mihomo
        run: |
          # è®¾ç½®è¶…æ—¶å’Œé‡è¯•
          set -e
          
          echo "ğŸ“¥ è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯..."
          LATEST_VERSION=$(curl -sL --max-time 30 https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.tag_name')
          
          if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
            echo "âŒ æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯ï¼Œä½¿ç”¨å›ºå®šç‰ˆæœ¬"
            LATEST_VERSION="v1.18.10"
          fi
          
          echo "âœ… ç‰ˆæœ¬: $LATEST_VERSION"
          
          # æ„å»ºä¸‹è½½ URL
          DOWNLOAD_URL="https://github.com/MetaCubeX/mihomo/releases/download/${LATEST_VERSION}/mihomo-linux-amd64-${LATEST_VERSION}.gz"
          echo "ğŸ“¦ ä¸‹è½½åœ°å€: $DOWNLOAD_URL"
          
          # ä¸‹è½½ï¼Œè®¾ç½®è¶…æ—¶å’Œé‡è¯•
          for i in {1..3}; do
            echo "â³ å°è¯•ä¸‹è½½ (ç¬¬ $i æ¬¡)..."
            if wget --timeout=60 --tries=3 -q --show-progress "$DOWNLOAD_URL"; then
              echo "âœ… ä¸‹è½½æˆåŠŸ"
              break
            else
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
              sleep 5
            fi
            
            if [ $i -eq 3 ]; then
              echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº..."
              # å°è¯•ä½¿ç”¨ ghproxy é•œåƒ
              MIRROR_URL="https://mirror.ghproxy.com/${DOWNLOAD_URL}"
              wget --timeout=60 -q --show-progress "$MIRROR_URL"
            fi
          done
          
          # è§£å‹
          echo "ğŸ“‚ è§£å‹æ–‡ä»¶..."
          gunzip "mihomo-linux-amd64-${LATEST_VERSION}.gz"
          mv "mihomo-linux-amd64-${LATEST_VERSION}" mihomo
          chmod +x mihomo
          
          # éªŒè¯
          echo "ğŸ” éªŒè¯å®‰è£…..."
          ./mihomo version || echo "âš ï¸ ç‰ˆæœ¬ä¿¡æ¯è·å–å¤±è´¥ï¼Œä½†æ–‡ä»¶å·²ä¸‹è½½"
      
      - name: åˆ›å»ºè¾“å‡ºç›®å½•
        run: |
          mkdir -p rules/mrs
      
      - name: è½¬æ¢è§„åˆ™æ–‡ä»¶
        run: |
          # éå†æ‰€æœ‰æ–‡æœ¬è§„åˆ™æ–‡ä»¶å¹¶è½¬æ¢
          for txt_file in rules/text/*.txt; do
            if [ -f "$txt_file" ]; then
              filename=$(basename "$txt_file" .txt)
              
              echo "æ­£åœ¨è½¬æ¢: $filename"
              
              # æ ¹æ®æ–‡ä»¶ååˆ¤æ–­è§„åˆ™ç±»å‹
              case "$filename" in
                domain|domain_suffix|domain_keyword)
                  behavior="domain"
                  ;;
                ipcidr|ip_cidr|ipcidr6)
                  behavior="ipcidr"
                  ;;
                classical|mixed)
                  behavior="classical"
                  ;;
                *)
                  # é»˜è®¤ä½¿ç”¨ domain
                  behavior="domain"
                  ;;
              esac
              
              # æ‰§è¡Œè½¬æ¢
              ./mihomo convert-ruleset "$behavior" text "$txt_file" "rules/mrs/${filename}.mrs"
              
              if [ $? -eq 0 ]; then
                echo "âœ… ${filename}.mrs è½¬æ¢æˆåŠŸ"
                ls -lh "rules/mrs/${filename}.mrs"
              else
                echo "âŒ ${filename}.mrs è½¬æ¢å¤±è´¥"
              fi
            fi
          done
      
      - name: ç”Ÿæˆè§„åˆ™åˆ—è¡¨
        run: |
          echo "# å¯ç”¨è§„åˆ™" > rules/mrs/README.md
          echo "" >> rules/mrs/README.md
          echo "ç”Ÿæˆæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> rules/mrs/README.md
          echo "" >> rules/mrs/README.md
          echo "| æ–‡ä»¶å | å¤§å° | ä¸‹è½½é“¾æ¥ |" >> rules/mrs/README.md
          echo "|--------|------|----------|" >> rules/mrs/README.md
          
          for mrs_file in rules/mrs/*.mrs; do
            if [ -f "$mrs_file" ]; then
              filename=$(basename "$mrs_file")
              filesize=$(ls -lh "$mrs_file" | awk '{print $5}')
              echo "| $filename | $filesize | [ä¸‹è½½](https://github.com/${{ github.repository }}/releases/latest/download/$filename) |" >> rules/mrs/README.md
            fi
          done
      
      - name: æäº¤è½¬æ¢ç»“æœ
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add rules/mrs/
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨è½¬æ¢ MRS è§„åˆ™ [$(date '+%Y-%m-%d %H:%M:%S')]"
          git push
      
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: MRS Rules v${{ github.run_number }}
          body: |
            ğŸ‰ è‡ªåŠ¨ç”Ÿæˆçš„ MRS è§„åˆ™é›†
            
            **ç”Ÿæˆæ—¶é—´**: ${{ github.event.head_commit.timestamp }}
            **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}
            
            ## ğŸ“¥ ä½¿ç”¨æ–¹æ³•
            
            åœ¨ mihomo é…ç½®ä¸­æ·»åŠ ï¼š
            
            ```yaml
            rule-providers:
              my-rules:
                type: http
                behavior: domain  # æ ¹æ®å®é™…ç±»å‹ä¿®æ”¹
                format: mrs
                url: "https://github.com/${{ github.repository }}/releases/latest/download/domain.mrs"
                interval: 86400
            ```
            
            ## ğŸ“‹ å¯ç”¨æ–‡ä»¶
            
            æŸ¥çœ‹ä¸‹æ–¹ Assets ä¸­çš„æ‰€æœ‰ .mrs æ–‡ä»¶
          files: |
            rules/mrs/*.mrs
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
